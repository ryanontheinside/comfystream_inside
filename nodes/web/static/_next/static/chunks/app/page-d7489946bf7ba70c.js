(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{6182:(e,t,a)=>{Promise.resolve().then(a.bind(a,1498))},1498:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>eN});var r=a(5155),n=a(2115);let l=n.createContext(void 0);function s(){let e=n.useContext(l);if(!e)throw Error("tried to access peer context outside of Peer component");return e}let o=e=>{var t;let a=function(e){let{url:t,prompts:a,connect:r,onConnected:l,onDisconnected:s,localStream:o}=e,[d,i]=n.useState(null),[c,u]=n.useState(null),[m,f]=n.useState(null),p=n.useRef(null),h=async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{let r=await fetch("/api/offer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:e,prompts:a,offer:t})});if(!r.ok)throw Error("offer HTTP error: ".concat(r.status));return await r.json()}catch(a){if(r<5)return await new Promise(e=>setTimeout(e,500)),h(e,t,r+1);throw a}},v=e=>{switch(e){case"connected":l();break;case"disconnected":s()}};return n.useEffect(()=>{if(r){if(d||!o)return;let e=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});i(e),o.getVideoTracks().length>0&&e.addTransceiver("video"),o.getTracks().forEach(t=>{e.addTrack(t,o)});let a=e.createDataChannel("control");a.onopen=()=>{console.log("[usePeer] Control channel opened, readyState:",a.readyState),f(a)},a.onclose=()=>{console.log("[usePeer] Control channel closed"),f(null)},e.ontrack=e=>{e.streams&&e.streams[0]&&u(e.streams[0])},a.onerror=e=>{console.error("Control channel error:",e)},a.onmessage=e=>{console.log("Received message on control channel:",e.data)},e.onicecandidate=async a=>{if(!a.candidate){let a=await h(t,e.localDescription);await e.setRemoteDescription(a)}},e.onconnectionstatechange=t=>{v(e.connectionState)},(async()=>{let t=await e.createOffer();await e.setLocalDescription(t)})().catch(console.error)}else p.current&&clearTimeout(p.current),d&&d.close(),f(null),u(null),i(null)},[r,o]),{peerConnection:d,remoteStream:c,controlChannel:m}}(e);return console.log("[PeerConnector] Peer context value:",{hasControlChannel:!!(null==a?void 0:a.controlChannel),controlChannelState:null==a?void 0:null===(t=a.controlChannel)||void 0===t?void 0:t.readyState}),(0,r.jsx)("div",{children:a&&(0,r.jsx)(l.Provider,{value:a,children:e.children})})};var d=a(2317),i=a(652),c=a(3463),u=a(9795);function m(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,u.QP)((0,c.$)(t))}let f=(0,i.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),p=n.forwardRef((e,t)=>{let{className:a,variant:n,size:l,asChild:s=!1,...o}=e,i=s?d.DX:"button";return(0,r.jsx)(i,{className:m(f({variant:n,size:l,className:a})),ref:t,...o})});p.displayName="Button";var h=a(6217),v=a(767);let x=h.bL;h.l9;let g=h.ZL;h.bm;let b=n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,r.jsx)(h.hJ,{ref:t,className:m("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...n})});b.displayName=h.hJ.displayName;let j=n.forwardRef((e,t)=>{let{className:a,children:n,...l}=e;return(0,r.jsxs)(g,{children:[(0,r.jsx)(b,{}),(0,r.jsxs)(h.UC,{ref:t,className:m("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...l,children:[n,(0,r.jsxs)(h.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,r.jsx)(v.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});j.displayName=h.UC.displayName;let N=e=>{let{className:t,...a}=e;return(0,r.jsx)("div",{className:m("flex flex-col space-y-1.5 text-center sm:text-left",t),...a})};N.displayName="DialogHeader";let y=n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,r.jsx)(h.hE,{ref:t,className:m("text-lg font-semibold leading-none tracking-tight",a),...n})});y.displayName=h.hE.displayName,n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,r.jsx)(h.VY,{ref:t,className:m("text-sm text-muted-foreground",a),...n})}).displayName=h.VY.displayName;var w=a(9847);let C=e=>{let{shouldScaleBackground:t=!0,...a}=e;return(0,r.jsx)(w._s.Root,{shouldScaleBackground:t,...a})};C.displayName="Drawer",w._s.Trigger;let S=w._s.Portal;w._s.Close;let k=n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,r.jsx)(w._s.Overlay,{ref:t,className:m("fixed inset-0 z-50 bg-black/80",a),...n})});k.displayName=w._s.Overlay.displayName;let I=n.forwardRef((e,t)=>{let{className:a,children:n,...l}=e;return(0,r.jsxs)(S,{children:[(0,r.jsx)(k,{}),(0,r.jsxs)(w._s.Content,{ref:t,className:m("fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",a),...l,children:[(0,r.jsx)("div",{className:"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted"}),n]})]})});I.displayName="DrawerContent";let R=e=>{let{className:t,...a}=e;return(0,r.jsx)("div",{className:m("grid gap-1.5 p-4 text-center sm:text-left",t),...a})};R.displayName="DrawerHeader";let E=n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,r.jsx)(w._s.Title,{ref:t,className:m("text-lg font-semibold leading-none tracking-tight",a),...n})});E.displayName=w._s.Title.displayName,n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,r.jsx)(w._s.Description,{ref:t,className:m("text-sm text-muted-foreground",a),...n})}).displayName=w._s.Description.displayName;var D=a(9606),A=a(6195);let O=(0,i.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),P=n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,r.jsx)(A.b,{ref:t,className:m(O(),a),...n})});P.displayName=A.b.displayName;let F=D.Op,U=n.createContext({}),T=e=>{let{...t}=e;return(0,r.jsx)(U.Provider,{value:{name:t.name},children:(0,r.jsx)(D.xI,{...t})})},_=()=>{let e=n.useContext(U),t=n.useContext(L),{getFieldState:a,formState:r}=(0,D.xW)(),l=a(e.name,r);if(!e)throw Error("useFormField should be used within <FormField>");let{id:s}=t;return{id:s,name:e.name,formItemId:"".concat(s,"-form-item"),formDescriptionId:"".concat(s,"-form-item-description"),formMessageId:"".concat(s,"-form-item-message"),...l}},L=n.createContext({}),V=n.forwardRef((e,t)=>{let{className:a,...l}=e,s=n.useId();return(0,r.jsx)(L.Provider,{value:{id:s},children:(0,r.jsx)("div",{ref:t,className:m("space-y-2",a),...l})})});V.displayName="FormItem";let z=n.forwardRef((e,t)=>{let{className:a,...n}=e,{error:l,formItemId:s}=_();return(0,r.jsx)(P,{ref:t,className:m(l&&"text-destructive",a),htmlFor:s,...n})});z.displayName="FormLabel";let J=n.forwardRef((e,t)=>{let{...a}=e,{error:n,formItemId:l,formDescriptionId:s,formMessageId:o}=_();return(0,r.jsx)(d.DX,{ref:t,id:l,"aria-describedby":n?"".concat(s," ").concat(o):"".concat(s),"aria-invalid":!!n,...a})});J.displayName="FormControl",n.forwardRef((e,t)=>{let{className:a,...n}=e,{formDescriptionId:l}=_();return(0,r.jsx)("p",{ref:t,id:l,className:m("text-sm text-muted-foreground",a),...n})}).displayName="FormDescription";let M=n.forwardRef((e,t)=>{let{className:a,children:n,...l}=e,{error:s,formMessageId:o}=_(),d=s?String(null==s?void 0:s.message):n;return d?(0,r.jsx)("p",{ref:t,id:o,className:m("text-sm font-medium text-destructive",a),...l,children:d}):null});M.displayName="FormMessage";let q=n.forwardRef((e,t)=>{let{className:a,...n}=e;return(0,r.jsx)("input",{className:m("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 u-ios-text-base u-ios-file-text-base",a),ref:t,...n})});q.displayName="Input";var W=a(2679),H=a(3415),B=a(4140),X=a(1719),$=a(8867);let Y=e=>(0,r.jsx)(B.bL,{...e});Y.displayName=B.bL.displayName;let Z=n.forwardRef((e,t)=>{let{className:a,children:n,...l}=e;return(0,r.jsxs)(B.l9,{ref:t,className:m("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 u-ios-text-base",a),...l,children:[n,(0,r.jsx)(B.In,{asChild:!0,children:(0,r.jsx)(X.A,{className:"h-4 w-4 opacity-50"})})]})});Z.displayName=B.l9.displayName;let G=n.forwardRef((e,t)=>{let{className:a,children:n,position:l="popper",...s}=e;return(0,r.jsx)(B.ZL,{children:(0,r.jsx)(B.UC,{ref:t,className:m("relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===l&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:l,...s,children:(0,r.jsx)(B.LM,{className:m("p-1","popper"===l&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:n})})})});G.displayName=B.UC.displayName;let K=n.forwardRef((e,t)=>{let{className:a,children:n,...l}=e;return(0,r.jsxs)(B.q7,{ref:t,className:m("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 u-ios-text-base",a),...l,children:[(0,r.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,r.jsx)(B.VF,{children:(0,r.jsx)($.A,{className:"h-4 w-4"})})}),(0,r.jsx)(B.p4,{children:n})]})});K.displayName=B.q7.displayName,Y.Trigger=Z,Y.Content=G,Y.Option=K;var Q=a(814);let ee={streamUrl:a(2818).env.NEXT_PUBLIC_DEFAULT_STREAM_URL||"http://127.0.0.1:8889",frameRate:30,selectedVideoDeviceId:"none",selectedAudioDeviceId:"none"};function et(e){let{open:t,onOpenChange:a,onSave:l}=e,s=function(e){let[t,a]=n.useState(!1);return n.useEffect(()=>{function t(e){a(e.matches)}let r=matchMedia(e);return r.addEventListener("change",t),a(r.matches),()=>r.removeEventListener("change",t)},[e]),t}("(min-width: 768px)"),[o,d]=(0,n.useState)(ee),i=e=>{d(e),l(e),a(!1)};return s?(0,r.jsx)(x,{open:t,onOpenChange:a,children:(0,r.jsxs)(j,{"aria-describedby":void 0,children:[(0,r.jsx)(N,{className:"text-left",children:(0,r.jsx)(y,{children:(0,r.jsx)("div",{className:"mt-4",children:"Stream Settings"})})}),(0,r.jsx)(el,{config:o,onSubmit:i})]})}):(0,r.jsx)(C,{open:t,onOpenChange:a,children:(0,r.jsxs)(I,{children:[(0,r.jsx)(R,{className:"text-left",children:(0,r.jsx)(E,{children:"Stream Settings"})}),(0,r.jsx)("div",{className:"px-4",children:(0,r.jsx)(el,{config:o,onSubmit:i})})]})})}let ea=H.z.object({streamUrl:H.z.string().url(),frameRate:H.z.coerce.number()}),er=(0,n.createContext)({originalPrompts:null,currentPrompts:null,setOriginalPrompts:()=>{},setCurrentPrompts:()=>{}}),en=()=>(0,n.useContext)(er);function el(e){var t,a;let{config:l,onSubmit:s}=e,[o,d]=(0,n.useState)([]),{setOriginalPrompts:i}=en(),[c,u]=(0,n.useState)([]),[m,f]=(0,n.useState)([]),[h,v]=(0,n.useState)(l.selectedVideoDeviceId),[x,g]=(0,n.useState)(l.selectedAudioDeviceId),b=(0,D.mN)({resolver:(0,W.u)(ea),defaultValues:l}),j=(0,n.useCallback)(async()=>{try{await navigator.mediaDevices.getUserMedia({video:!0});let e=await navigator.mediaDevices.enumerateDevices(),t=[{deviceId:"none",label:"No Video"},...e.filter(e=>"videoinput"===e.kind).map(e=>({deviceId:e.deviceId,label:e.label||"Camera ".concat(e.deviceId.slice(0,5),"...")}))];u(t),"none"==h&&t.length>1&&v(t[1].deviceId)}catch(e){console.log("Failed to get video devices: ".concat(e)),Q.oR.error("Failed to get video devices",{description:"Please make sure your camera is connected and enabled."})}},[]),N=(0,n.useCallback)(async()=>{try{await navigator.mediaDevices.getUserMedia({audio:!0});let e=await navigator.mediaDevices.enumerateDevices(),t=[{deviceId:"none",label:"No Audio"},...e.filter(e=>"audioinput"===e.kind).map(e=>({deviceId:e.deviceId,label:e.label||"Microphone ".concat(e.deviceId.slice(0,5),"...")}))];f(t),"none"==x&&t.length>1&&g(t[0].deviceId)}catch(e){console.error("Failed to get audio devices: ",e),Q.oR.error("Failed to get audio devices",{description:"Please make sure your microphone is connected and enabled."})}},[]);(0,n.useEffect)(()=>(j(),N(),navigator.mediaDevices.addEventListener("devicechange",j),navigator.mediaDevices.addEventListener("devicechange",N),()=>{navigator.mediaDevices.removeEventListener("devicechange",j),navigator.mediaDevices.removeEventListener("devicechange",N)}),[j,N]);let y=async e=>{var t;if(null===(t=e.target.files)||void 0===t?void 0:t.length)try{let t=Array.from(e.target.files).map(async e=>{let t=await e.text();return JSON.parse(t)}),a=await Promise.all(t);d(a),i(a)}catch(e){console.error("Failed to parse one or more JSON files.",e),Q.oR.error("Failed to Parse Workflow",{description:"Please upload a valid JSON file."})}};return(0,r.jsx)(F,{...b,children:(0,r.jsxs)("form",{onSubmit:b.handleSubmit(e=>{s({...e,streamUrl:e.streamUrl?e.streamUrl.replace(/\/+$/,""):e.streamUrl,prompts:o,selectedVideoDeviceId:h||"none",selectedAudioDeviceId:x||"none"})}),autoComplete:"off",children:[(0,r.jsx)(T,{control:b.control,name:"streamUrl",render:e=>{let{field:t}=e;return(0,r.jsxs)(V,{className:"mt-4",children:[(0,r.jsx)(z,{children:"Stream URL"}),(0,r.jsx)(J,{children:(0,r.jsx)(q,{placeholder:"Stream URL",...t})}),(0,r.jsx)(M,{})]})}}),(0,r.jsx)(T,{control:b.control,name:"frameRate",render:e=>{let{field:t}=e;return(0,r.jsxs)(V,{className:"mt-4",children:[(0,r.jsx)(z,{children:"Frame Rate"}),(0,r.jsx)(J,{children:(0,r.jsx)(q,{placeholder:"Frame Rate",...t,type:"number"})}),(0,r.jsx)(M,{})]})}}),(0,r.jsxs)("div",{className:"mt-4 mb-4",children:[(0,r.jsx)(P,{children:"Camera"}),(0,r.jsxs)(Y,{required:!0,value:h,onValueChange:e=>{e!==h&&(v(e),"none"!==e&&g("none"))},children:[(0,r.jsx)(Y.Trigger,{className:"w-full mt-2",children:h&&(null===(t=c.find(e=>e.deviceId===h))||void 0===t?void 0:t.label)||"None"}),(0,r.jsx)(Y.Content,{children:0===c.length?(0,r.jsx)(Y.Option,{disabled:!0,value:"no-devices",children:"No camera devices found"}):c.map(e=>(0,r.jsx)(Y.Option,{value:e.deviceId,children:e.label},e.deviceId))})]})]}),(0,r.jsxs)("div",{className:"mt-4 mb-4",children:[(0,r.jsx)(P,{children:"Microphone"}),(0,r.jsxs)(Y,{value:x,onValueChange:e=>{e!==x&&(g(e),"none"!==e&&v("none"))},children:[(0,r.jsx)(Y.Trigger,{className:"w-full mt-2",children:x&&(null===(a=m.find(e=>e.deviceId===x))||void 0===a?void 0:a.label)||"None"}),(0,r.jsx)(Y.Content,{children:0===m.length?(0,r.jsx)(Y.Option,{disabled:!0,value:"no-devices",children:"No audio devices found"}):m.filter(e=>void 0!==e.deviceId&&""!=e.deviceId).map(e=>(0,r.jsx)(Y.Option,{value:e.deviceId,children:e.label},e.deviceId))})]})]}),(0,r.jsxs)("div",{className:"mt-4 mb-4 grid max-w-sm items-center gap-3",children:[(0,r.jsx)(P,{children:"Comfy Workflows"}),(0,r.jsx)(q,{id:"workflow",type:"file",accept:".json",multiple:!0,onChange:y,required:!0})]}),(0,r.jsx)(p,{type:"submit",className:"w-full mt-4 mb-4",children:"Start Stream"})]})})}var es=a(9710);let eo=es.Kq,ed=es.bL,ei=es.l9,ec=n.forwardRef((e,t)=>{let{className:a,sideOffset:n=4,...l}=e;return(0,r.jsx)(es.UC,{ref:t,sideOffset:n,className:m("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...l})});function eu(e){let{stream:t,frameRate:a,onStreamReady:l}=e,s=(0,n.useRef)(null),o=(0,n.useRef)(null);return((0,n.useEffect)(()=>{if(!t||0===t.getVideoTracks().length)return;let e=s.current.getContext("2d"),a=!0,r=()=>{if(!a||!o.current)return;let t=o.current;if(!(null==t?void 0:t.videoWidth)){requestAnimationFrame(r);return}let n=Math.max(512/t.videoWidth,512/t.videoHeight),l=t.videoWidth*n,s=t.videoHeight*n;e.fillStyle="black",e.fillRect(0,0,512,512),e.drawImage(t,(512-l)/2,(512-s)/2,l,s),requestAnimationFrame(r)};return r(),()=>{a=!1}},[t]),(0,n.useEffect)(()=>{if(!t||0===t.getVideoTracks().length)return;o.current||(o.current=document.createElement("video"),o.current.muted=!0);let e=o.current;return e.srcObject=t,e.onloadedmetadata=()=>{e.play().catch(e=>{console.error("Video play failed:",e)})},()=>{e&&(e.pause(),e.srcObject=null)}},[t]),t&&0!==t.getVideoTracks().length)?(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("canvas",{ref:s,width:512,height:512,className:"w-full h-full"}),(0,r.jsx)("div",{className:"absolute top-2 right-2 bg-black/50 text-white px-2 py-1 rounded text-sm",children:(0,r.jsx)(eo,{children:(0,r.jsxs)(ed,{children:[(0,r.jsxs)(ei,{children:[a," FPS"]}),(0,r.jsx)(ec,{children:(0,r.jsx)("p",{children:"This is the requested FPS of your device."})})]})})})]})}):null}function em(e){let{onStreamReady:t,deviceId:a,frameRate:l,selectedAudioDeviceId:s}=e,[o,d]=(0,n.useState)(null),i=(0,n.useCallback)(e=>{d(t=>(t&&t.getTracks().forEach(e=>e.stop()),e))},[]),c=(0,n.useCallback)(async()=>{if("none"===a&&"none"===s||0==l)return null;try{return await navigator.mediaDevices.getUserMedia({video:"none"!==a&&{deviceId:{exact:a},width:{ideal:512},height:{ideal:512},aspectRatio:{ideal:1},frameRate:{ideal:l,max:l}},audio:"none"!==s&&{deviceId:{exact:s},sampleRate:48e3,channelCount:2,sampleSize:16,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}})}catch(e){return console.error("Error accessing media devices.",e),null}},[a,l,s]);(0,n.useEffect)(()=>{if(("none"!==a||"none"!==s)&&0!=l)return c().then(e=>{e&&(i(e),d(e),t(e))}),()=>{i(null)}},[a,l,s,c,i,t]);let u=o&&o.getVideoTracks().length>0,m=o&&o.getAudioTracks().length>0;return!u&&m?(0,r.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,r.jsx)("span",{className:"text-white",children:"Audio Only"})}):o&&(u||m)?(0,r.jsx)("div",{children:(0,r.jsx)(eu,{stream:o,frameRate:l,onStreamReady:()=>{}})}):null}ec.displayName=es.UC.displayName;let ef=e=>{let{input:t,value:a,onChange:n}=e;if("combo"===t.widget)return(0,r.jsx)("select",{value:a,onChange:e=>n(e.target.value),className:"p-2 border rounded w-full",children:Array.isArray(t.value)&&t.value.map(e=>(0,r.jsx)("option",{value:e,children:e},e))});let l=t.type.toLowerCase();switch(l){case"boolean":return(0,r.jsx)("input",{type:"checkbox",checked:"true"===a,onChange:e=>n(e.target.checked.toString()),className:"w-5 h-5"});case"number":case"float":case"int":return(0,r.jsx)("input",{type:"number",value:a,onChange:e=>n(e.target.value),min:t.min,max:t.max,step:"float"===l?"0.01":"int"===l?"1":"any",className:"p-2 border rounded w-32"});case"string":return(0,r.jsx)("input",{type:"text",value:a,onChange:e=>n(e.target.value),className:"p-2 border rounded w-full"});default:return console.warn("Unhandled input type: ".concat(t.type)),(0,r.jsx)("input",{type:"text",value:a,onChange:e=>n(e.target.value),className:"p-2 border rounded w-full"})}},ep=e=>{var t,a,l,o,d,i,c,u,m,f,p,h;let{panelState:v,onStateChange:x}=e,{controlChannel:g}=s(),{currentPrompts:b,setCurrentPrompts:j}=en(),[N,y]=(0,n.useState)({}),w=n.useRef(null),C=n.useRef(null);(0,n.useEffect)(()=>()=>{C.current&&clearTimeout(C.current)},[]),(0,n.useEffect)(()=>{g&&(g.send(JSON.stringify({type:"get_nodes"})),g.addEventListener("message",e=>{try{let t=JSON.parse(e.data);"nodes_info"===t.type?y(t.nodes):"prompts_updated"!==t.type||t.success||console.error("[ControlPanel] Failed to update prompt")}catch(e){console.error("[ControlPanel] Error parsing node info:",e)}}))},[g]),(0,n.useEffect)(()=>{var e;let t=v.nodeId&&v.fieldName?null===(e=N[v.nodeId])||void 0===e?void 0:e.inputs[v.fieldName]:null;if(!t||!b)return;let a=!0,r=v.value;switch(t.type.toLowerCase()){case"number":a=/^-?\d*\.?\d*$/.test(v.value)&&""!==v.value,r=parseFloat(v.value);break;case"boolean":a="true"===v.value||"false"===v.value,r="true"===v.value;break;case"string":r=v.value;break;default:t.widget,a=""!==v.value,r=v.value}let n=""!==v.nodeId.trim()&&""!==v.fieldName.trim(),l=w.current,s=!l||l.nodeId!==v.nodeId||l.fieldName!==v.fieldName||l.value!==r;g&&v.isAutoUpdateEnabled&&a&&n&&s&&(C.current&&clearTimeout(C.current),C.current=setTimeout(()=>{let e=JSON.parse(JSON.stringify(b[0]));if(e[v.nodeId]&&e[v.nodeId].inputs){e[v.nodeId].inputs[v.fieldName]=r,w.current={nodeId:v.nodeId,fieldName:v.fieldName,value:r};let t=JSON.stringify({type:"update_prompts",prompts:[e]});g.send(t),j([e])}},"number"===t.type.toLowerCase()?100:300))},[v.value,v.nodeId,v.fieldName,v.isAutoUpdateEnabled,g,N,b,j]);let S=e=>{var t,a;return"boolean"===e.type.toLowerCase()?(!!e.value).toString():"combo"===e.widget&&Array.isArray(e.value)?(null===(a=e.value[0])||void 0===a?void 0:a.toString())||"":(null===(t=e.value)||void 0===t?void 0:t.toString())||"0"};return(0,r.jsxs)("div",{className:"flex flex-col gap-3 p-3",children:[(0,r.jsxs)("select",{value:v.nodeId,onChange:e=>{x({nodeId:e.target.value,fieldName:"",value:"0"})},className:"p-2 border rounded",children:[(0,r.jsx)("option",{value:"",children:"Select Node"}),Object.entries(N).map(e=>{let[t,a]=e;return(0,r.jsxs)("option",{value:t,children:[t," (",a.class_type,")"]},t)})]}),(0,r.jsxs)("select",{value:v.fieldName,onChange:e=>{var t;let a=e.target.value,r=null===(t=N[v.nodeId])||void 0===t?void 0:t.inputs[a];r?x({fieldName:a,value:S(r)}):x({fieldName:a})},disabled:!v.nodeId,className:"p-2 border rounded",children:[(0,r.jsx)("option",{value:"",children:"Select Field"}),v.nodeId&&(null===(t=N[v.nodeId])||void 0===t?void 0:t.inputs)&&Object.entries(N[v.nodeId].inputs).filter(e=>{let[t,a]=e;return["boolean","number","float","int","string"].includes("string"==typeof a.type?a.type.toLowerCase():String(a.type).toLowerCase())||"combo"===a.widget}).map(e=>{let[t,a]=e;return(0,r.jsxs)("option",{value:t,children:[t," (",a.type,a.widget?" - ".concat(a.widget):"",")"]},t)})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[v.nodeId&&v.fieldName&&(null===(a=N[v.nodeId])||void 0===a?void 0:a.inputs[v.fieldName])&&(0,r.jsx)(ef,{input:N[v.nodeId].inputs[v.fieldName],value:v.value,onChange:e=>{var t;let a=v.nodeId&&v.fieldName?null===(t=N[v.nodeId])||void 0===t?void 0:t.inputs[v.fieldName]:null;if(a&&"number"===a.type){let t=parseFloat(e);if(!isNaN(t)&&(void 0!==a.min&&t<a.min||void 0!==a.max&&t>a.max))return}x({value:e})}}),v.nodeId&&v.fieldName&&(null===(o=N[v.nodeId])||void 0===o?void 0:null===(l=o.inputs[v.fieldName])||void 0===l?void 0:l.type)==="number"&&(0,r.jsx)("span",{className:"text-sm text-gray-600",children:(null===(i=N[v.nodeId])||void 0===i?void 0:null===(d=i.inputs[v.fieldName])||void 0===d?void 0:d.min)!==void 0&&(null===(u=N[v.nodeId])||void 0===u?void 0:null===(c=u.inputs[v.fieldName])||void 0===c?void 0:c.max)!==void 0&&"(".concat(null===(f=N[v.nodeId])||void 0===f?void 0:null===(m=f.inputs[v.fieldName])||void 0===m?void 0:m.min," - ").concat(null===(h=N[v.nodeId])||void 0===h?void 0:null===(p=h.inputs[v.fieldName])||void 0===p?void 0:p.max,")")})]}),(0,r.jsxs)("button",{onClick:()=>{x({isAutoUpdateEnabled:!v.isAutoUpdateEnabled})},disabled:!g,className:"p-2 rounded ".concat(g?v.isAutoUpdateEnabled?"bg-green-500 text-white":"bg-red-500 text-white":"bg-gray-300 text-gray-600 cursor-not-allowed"),children:["Auto-Update ",g?v.isAutoUpdateEnabled?"(ON)":"(OFF)":"(Not Connected)"]})]})};var eh=a(8236),ev=a(3473);let ex=()=>{let[e,t]=(0,n.useState)([0]),[a,l]=(0,n.useState)(1),[s,o]=(0,n.useState)(!1),[d,i]=(0,n.useState)({0:{nodeId:"",fieldName:"",value:"0",isAutoUpdateEnabled:!1}}),c=a=>{t(e.filter(e=>e!==a)),i(e=>{let t={...e};return delete t[a],t})},u=(e,t)=>{i(a=>({...a,[e]:{...a[e],...t}}))};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(p,{onClick:()=>o(!0),className:"fixed bottom-4 right-4 h-12 w-12 rounded-full p-0 shadow-lg hover:shadow-xl transition-shadow",variant:"default",children:(0,r.jsx)(eh.A,{className:"h-6 w-6"})}),(0,r.jsxs)(C,{open:s,onOpenChange:o,direction:"bottom",shouldScaleBackground:!1,children:[(0,r.jsx)("style",{children:"\n            [data-vaul-overlay] {\n              background-color: transparent !important;\n              background: transparent !important;\n            }\n            \n            /* Custom scrollbar styling */\n            #control-panel-drawer ::-webkit-scrollbar {\n              width: 8px;\n              height: 8px;\n            }\n            \n            #control-panel-drawer ::-webkit-scrollbar-track {\n              background: transparent;\n            }\n            \n            #control-panel-drawer ::-webkit-scrollbar-thumb {\n              background: #cbd5e1;\n              border-radius: 4px;\n            }\n            \n            #control-panel-drawer ::-webkit-scrollbar-thumb:hover {\n              background: #94a3b8;\n            }\n          "}),(0,r.jsxs)(I,{id:"control-panel-drawer",className:"max-h-[50vh] min-h-[200px] bg-background/90 backdrop-blur-md border-t shadow-lg overflow-hidden",children:[(0,r.jsx)(E,{className:"sr-only",children:"Control Panels"}),(0,r.jsxs)("div",{className:"flex h-full",children:[(0,r.jsx)("div",{className:"w-12 border-r flex items-start pt-4 justify-center bg-background/50",children:(0,r.jsx)(p,{onClick:()=>{t([...e,a]),i(e=>({...e,[a]:{nodeId:"",fieldName:"",value:"0",isAutoUpdateEnabled:!1}})),l(a+1)},variant:"ghost",size:"icon",className:"h-8 w-8 rounded-md bg-blue-500 hover:bg-blue-600 active:bg-blue-700 transition-colors shadow-sm hover:shadow text-white",title:"Add control panel","aria-label":"Add control panel","data-tooltip":"Add control panel",children:(0,r.jsx)(ev.A,{className:"h-4 w-4"})})}),(0,r.jsx)("div",{className:"flex-1 overflow-x-auto",children:(0,r.jsx)("div",{className:"flex gap-4 p-4 min-h-0",children:e.map(e=>(0,r.jsxs)("div",{className:"flex-none w-80 border rounded-lg bg-white/95 shadow-sm hover:shadow-md transition-shadow overflow-hidden flex flex-col max-h-[calc(50vh-3rem)]",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center p-2 border-b bg-gray-50/80",children:[(0,r.jsxs)("span",{className:"font-medium",children:["Control Panel ",e+1]}),(0,r.jsx)(p,{onClick:()=>c(e),variant:"ghost",size:"sm",className:"h-6 w-6 rounded-full p-0 hover:bg-gray-200/80 transition-colors",children:(0,r.jsx)("span",{className:"text-sm",children:"\xd7"})})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,r.jsx)(ep,{panelState:d[e],onStateChange:t=>u(e,t)})})]},e))})})]})]})]})]})};function eg(e){let{stream:t}=e,a=(0,n.useRef)(null),[l,s]=(0,n.useState)(!1);t.getVideoTracks().length,(0,n.useEffect)(()=>{if(!a.current||!t)return;let e=a.current;return e.srcObject=t,s(!1),(async()=>{try{e&&e.srcObject&&(await e.play(),s(!1))}catch(e){console.warn("Autoplay prevented:",e),s(!0)}})(),()=>{e&&(e.srcObject=null,e.pause())}},[t]);let o=async()=>{try{a.current&&(await a.current.play(),s(!1))}catch(e){console.warn("Manual play failed:",e)}};return(0,r.jsxs)("div",{className:"relative w-full h-full",children:[(0,r.jsx)("video",{ref:a,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),l&&(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-black/50",children:(0,r.jsx)("button",{onClick:o,className:"px-4 py-2 bg-white text-black rounded-md hover:bg-gray-200 transition-colors",children:"Click to Play"})})]})}function eb(e){let{connected:t,onStreamReady:a}=e,{remoteStream:l,peerConnection:o}=s(),[d,i]=(0,n.useState)(0);if((0,n.useEffect)(()=>{if(!t||!l)return;a();let e=setInterval(()=>{o&&o.getStats().then(e=>{e.forEach(e=>{if("inbound-rtp"===e.type&&"video"===e.kind){let t=e.framesPerSecond;t&&i(Math.round(t))}})})},1e3);return()=>clearInterval(e)},[t,l,o,a]),!t||!l)return(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("video",{className:"w-full h-full object-cover",autoPlay:!0,loop:!0,playsInline:!0,children:(0,r.jsx)("source",{src:"/loading.mp4",type:"video/mp4"})})});let c=l.getVideoTracks().length>0;return(0,r.jsxs)("div",{className:"relative w-full h-full",children:[(0,r.jsx)(eg,{stream:l}),c&&(0,r.jsx)("div",{className:"absolute top-2 right-2 bg-black/50 text-white px-2 py-1 rounded text-sm",children:(0,r.jsx)(eo,{children:(0,r.jsxs)(ed,{children:[(0,r.jsxs)(ei,{children:[d," FPS"]}),(0,r.jsx)(ec,{children:(0,r.jsx)("p",{children:"This is the FPS of the output stream."})})]})})})]})}let ej=()=>{let[e,t]=(0,n.useState)(!1),[a,l]=(0,n.useState)(!1),[s,d]=(0,n.useState)(!0),[i,c]=(0,n.useState)(null),[u,m]=(0,n.useState)(void 0),[f,p]=(0,n.useState)({streamUrl:"",frameRate:0,selectedVideoDeviceId:"",selectedAudioDeviceId:"",prompts:null}),h=(0,n.useRef)(!1),v=(0,n.useCallback)(e=>{c(e)},[]),x=(0,n.useCallback)(()=>{Q.oR.success("Started stream!",{id:u}),m(void 0)},[u]),g=(0,n.useCallback)(e=>{p(e)},[]);(0,n.useEffect)(()=>{h.current||(f.streamUrl?(t(!0),m(Q.oR.loading("Starting stream...")),h.current=!0):t(!1))},[f.streamUrl]);let b=(0,n.useCallback)(()=>{l(!0),h.current=!1},[]),j=(0,n.useCallback)(()=>{l(!1)},[]);return i&&i.getVideoTracks().length,(0,r.jsxs)("main",{className:"fixed inset-0 overflow-hidden overscroll-none",children:[(0,r.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"}),(0,r.jsx)("div",{className:"fixed inset-0 z-[-1] bg-cover bg-[black]",children:(0,r.jsx)(o,{url:f.streamUrl,prompts:f.prompts,connect:e,onConnected:b,onDisconnected:j,localStream:i,children:(0,r.jsxs)("div",{className:"min-h-[100dvh] flex flex-col items-center justify-center md:justify-start",children:[(0,r.jsxs)("div",{className:"w-full max-h-[100dvh] flex flex-col md:flex-row landscape:flex-row justify-center items-center lg:space-x-4 md:pt-[10vh]",children:[(0,r.jsxs)("div",{className:"relative w-full max-w-[100vw] h-auto aspect-square sm:max-w-[640px] sm:max-h-[640px] md:max-w-[512px] md:max-h-[512px] flex justify-center items-center bg-slate-900 sm:border-[2px] md:border-0 lg:border-2 rounded-md",children:[(0,r.jsx)(eb,{connected:a,onStreamReady:x}),(0,r.jsx)("div",{className:"absolute bottom-[8px] right-[8px] w-[70px] h-[70px] sm:w-[90px] sm:h-[90px] bg-slate-800 block md:hidden",children:(0,r.jsx)(em,{onStreamReady:v,deviceId:f.selectedVideoDeviceId,frameRate:f.frameRate,selectedAudioDeviceId:f.selectedAudioDeviceId})})]}),(0,r.jsx)("div",{className:"hidden md:flex w-full sm:w-full md:w-full h-[50dvh] sm:h-auto md:h-auto max-w-[512px] max-h-[512px] aspect-square justify-center items-center lg:border-2 lg:rounded-md bg-slate-800",children:(0,r.jsx)(em,{onStreamReady:v,deviceId:f.selectedVideoDeviceId,frameRate:f.frameRate,selectedAudioDeviceId:f.selectedAudioDeviceId})})]}),a&&(0,r.jsx)(ex,{}),(0,r.jsx)(et,{open:s,onOpenChange:d,onSave:g})]})})})]})};function eN(){let[e,t]=(0,n.useState)(null),[a,l]=(0,n.useState)(null);return(0,n.useEffect)(()=>{e&&l(JSON.parse(JSON.stringify(e)))},[e]),(0,r.jsx)(er.Provider,{value:{originalPrompts:e,currentPrompts:a,setOriginalPrompts:t,setCurrentPrompts:l},children:(0,r.jsx)("div",{className:"flex flex-col",children:(0,r.jsx)("div",{className:"w-full",children:(0,r.jsx)(ej,{})})})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[814,750,441,517,358],()=>t(6182)),_N_E=e.O()}]);