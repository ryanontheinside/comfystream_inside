(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{6182:(e,t,a)=>{Promise.resolve().then(a.bind(a,1498))},1498:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>eN});var r=a(5155),l=a(2115);let n=l.createContext(void 0);function s(){let e=l.useContext(n);if(!e)throw Error("tried to access peer context outside of Peer component");return e}let o=e=>{var t;let a=function(e){let{url:t,prompt:a,connect:r,onConnected:n,onDisconnected:s,localStream:o}=e,[d,i]=l.useState(null),[c,u]=l.useState(null),[m,f]=l.useState(null),p=l.useRef(null),x=async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{let r=await fetch("/api/offer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:e,prompt:a,offer:t})});if(!r.ok)throw Error("offer HTTP error: ".concat(r.status));return await r.json()}catch(a){if(r<5)return await new Promise(e=>setTimeout(e,500)),x(e,t,r+1);throw a}},h=e=>{switch(e){case"connected":n();break;case"disconnected":s()}};return l.useEffect(()=>{if(r){if(d||!o)return;let e=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302"]}]});i(e),e.addTransceiver("video"),o.getTracks().forEach(t=>{e.addTrack(t,o)});let a=e.createDataChannel("control");a.onopen=()=>{console.log("[usePeer] Control channel opened, readyState:",a.readyState),f(a)},a.onclose=()=>{console.log("[usePeer] Control channel closed"),f(null)},a.onerror=e=>{console.error("Control channel error:",e)},a.onmessage=e=>{console.log("Received message on control channel:",e.data)},e.ontrack=e=>{"video"==e.track.kind&&u(e.streams[0])},e.onicecandidate=async a=>{if(!a.candidate){let a=await x(t,e.localDescription);await e.setRemoteDescription(a)}},e.onconnectionstatechange=t=>{h(e.connectionState)},(async()=>{let t=await e.createOffer();await e.setLocalDescription(t)})().catch(console.error)}else p.current&&clearTimeout(p.current),d&&d.close(),f(null),u(null),i(null)},[r,o]),{peerConnection:d,remoteStream:c,controlChannel:m}}(e);return console.log("[PeerConnector] Peer context value:",{hasControlChannel:!!(null==a?void 0:a.controlChannel),controlChannelState:null==a?void 0:null===(t=a.controlChannel)||void 0===t?void 0:t.readyState}),(0,r.jsx)("div",{children:a&&(0,r.jsx)(n.Provider,{value:a,children:e.children})})};var d=a(2317),i=a(652),c=a(3463),u=a(9795);function m(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,u.QP)((0,c.$)(t))}let f=(0,i.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),p=l.forwardRef((e,t)=>{let{className:a,variant:l,size:n,asChild:s=!1,...o}=e,i=s?d.DX:"button";return(0,r.jsx)(i,{className:m(f({variant:l,size:n,className:a})),ref:t,...o})});p.displayName="Button";var x=a(6217),h=a(767);let v=x.bL;x.l9;let g=x.ZL;x.bm;let b=l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)(x.hJ,{ref:t,className:m("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...l})});b.displayName=x.hJ.displayName;let j=l.forwardRef((e,t)=>{let{className:a,children:l,...n}=e;return(0,r.jsxs)(g,{children:[(0,r.jsx)(b,{}),(0,r.jsxs)(x.UC,{ref:t,className:m("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",a),...n,children:[l,(0,r.jsxs)(x.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,r.jsx)(h.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});j.displayName=x.UC.displayName;let N=e=>{let{className:t,...a}=e;return(0,r.jsx)("div",{className:m("flex flex-col space-y-1.5 text-center sm:text-left",t),...a})};N.displayName="DialogHeader";let w=l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)(x.hE,{ref:t,className:m("text-lg font-semibold leading-none tracking-tight",a),...l})});w.displayName=x.hE.displayName,l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)(x.VY,{ref:t,className:m("text-sm text-muted-foreground",a),...l})}).displayName=x.VY.displayName;var y=a(9847);let C=e=>{let{shouldScaleBackground:t=!0,...a}=e;return(0,r.jsx)(y._s.Root,{shouldScaleBackground:t,...a})};C.displayName="Drawer",y._s.Trigger;let S=y._s.Portal;y._s.Close;let k=l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)(y._s.Overlay,{ref:t,className:m("fixed inset-0 z-50 bg-black/80",a),...l})});k.displayName=y._s.Overlay.displayName;let I=l.forwardRef((e,t)=>{let{className:a,children:l,...n}=e;return(0,r.jsxs)(S,{children:[(0,r.jsx)(k,{}),(0,r.jsxs)(y._s.Content,{ref:t,className:m("fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",a),...n,children:[(0,r.jsx)("div",{className:"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted"}),l]})]})});I.displayName="DrawerContent";let R=e=>{let{className:t,...a}=e;return(0,r.jsx)("div",{className:m("grid gap-1.5 p-4 text-center sm:text-left",t),...a})};R.displayName="DrawerHeader";let E=l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)(y._s.Title,{ref:t,className:m("text-lg font-semibold leading-none tracking-tight",a),...l})});E.displayName=y._s.Title.displayName,l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)(y._s.Description,{ref:t,className:m("text-sm text-muted-foreground",a),...l})}).displayName=y._s.Description.displayName;var U=a(9606),F=a(6195);let O=(0,i.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),P=l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)(F.b,{ref:t,className:m(O(),a),...l})});P.displayName=F.b.displayName;let D=U.Op,_=l.createContext({}),A=e=>{let{...t}=e;return(0,r.jsx)(_.Provider,{value:{name:t.name},children:(0,r.jsx)(U.xI,{...t})})},T=()=>{let e=l.useContext(_),t=l.useContext(L),{getFieldState:a,formState:r}=(0,U.xW)(),n=a(e.name,r);if(!e)throw Error("useFormField should be used within <FormField>");let{id:s}=t;return{id:s,name:e.name,formItemId:"".concat(s,"-form-item"),formDescriptionId:"".concat(s,"-form-item-description"),formMessageId:"".concat(s,"-form-item-message"),...n}},L=l.createContext({}),z=l.forwardRef((e,t)=>{let{className:a,...n}=e,s=l.useId();return(0,r.jsx)(L.Provider,{value:{id:s},children:(0,r.jsx)("div",{ref:t,className:m("space-y-2",a),...n})})});z.displayName="FormItem";let J=l.forwardRef((e,t)=>{let{className:a,...l}=e,{error:n,formItemId:s}=T();return(0,r.jsx)(P,{ref:t,className:m(n&&"text-destructive",a),htmlFor:s,...l})});J.displayName="FormLabel";let q=l.forwardRef((e,t)=>{let{...a}=e,{error:l,formItemId:n,formDescriptionId:s,formMessageId:o}=T();return(0,r.jsx)(d.DX,{ref:t,id:n,"aria-describedby":l?"".concat(s," ").concat(o):"".concat(s),"aria-invalid":!!l,...a})});q.displayName="FormControl",l.forwardRef((e,t)=>{let{className:a,...l}=e,{formDescriptionId:n}=T();return(0,r.jsx)("p",{ref:t,id:n,className:m("text-sm text-muted-foreground",a),...l})}).displayName="FormDescription";let M=l.forwardRef((e,t)=>{let{className:a,children:l,...n}=e,{error:s,formMessageId:o}=T(),d=s?String(null==s?void 0:s.message):l;return d?(0,r.jsx)("p",{ref:t,id:o,className:m("text-sm font-medium text-destructive",a),...n,children:d}):null});M.displayName="FormMessage";let V=l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)("input",{className:m("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 u-ios-text-base u-ios-file-text-base",a),ref:t,...l})});V.displayName="Input";var H=a(2679),W=a(3415),B=a(4140),X=a(1719),$=a(8867);let Y=e=>(0,r.jsx)(B.bL,{...e});Y.displayName=B.bL.displayName;let Z=l.forwardRef((e,t)=>{let{className:a,children:l,...n}=e;return(0,r.jsxs)(B.l9,{ref:t,className:m("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 u-ios-text-base",a),...n,children:[l,(0,r.jsx)(B.In,{asChild:!0,children:(0,r.jsx)(X.A,{className:"h-4 w-4 opacity-50"})})]})});Z.displayName=B.l9.displayName;let K=l.forwardRef((e,t)=>{let{className:a,children:l,position:n="popper",...s}=e;return(0,r.jsx)(B.ZL,{children:(0,r.jsx)(B.UC,{ref:t,className:m("relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===n&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",a),position:n,...s,children:(0,r.jsx)(B.LM,{className:m("p-1","popper"===n&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:l})})})});K.displayName=B.UC.displayName;let Q=l.forwardRef((e,t)=>{let{className:a,children:l,...n}=e;return(0,r.jsxs)(B.q7,{ref:t,className:m("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 u-ios-text-base",a),...n,children:[(0,r.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,r.jsx)(B.VF,{children:(0,r.jsx)($.A,{className:"h-4 w-4"})})}),(0,r.jsx)(B.p4,{children:l})]})});Q.displayName=B.q7.displayName,Y.Trigger=Z,Y.Content=K,Y.Option=Q;let G={streamUrl:a(2818).env.NEXT_PUBLIC_DEFAULT_STREAM_URL||"http://127.0.0.1:8889",frameRate:30,selectedDeviceId:void 0};function ee(e){let{open:t,onOpenChange:a,onSave:n}=e,s=function(e){let[t,a]=l.useState(!1);return l.useEffect(()=>{function t(e){a(e.matches)}let r=matchMedia(e);return r.addEventListener("change",t),a(r.matches),()=>r.removeEventListener("change",t)},[e]),t}("(min-width: 768px)"),[o,d]=(0,l.useState)(G),i=e=>{d(e),n(e),a(!1)};return s?(0,r.jsx)(v,{open:t,onOpenChange:a,children:(0,r.jsxs)(j,{"aria-describedby":void 0,children:[(0,r.jsx)(N,{className:"text-left",children:(0,r.jsx)(w,{children:(0,r.jsx)("div",{className:"mt-4",children:"Stream Settings"})})}),(0,r.jsx)(el,{config:o,onSubmit:i})]})}):(0,r.jsx)(C,{open:t,onOpenChange:a,children:(0,r.jsxs)(I,{children:[(0,r.jsx)(R,{className:"text-left",children:(0,r.jsx)(E,{children:"Stream Settings"})}),(0,r.jsx)("div",{className:"px-4",children:(0,r.jsx)(el,{config:o,onSubmit:i})})]})})}let et=W.z.object({streamUrl:W.z.string().url(),frameRate:W.z.coerce.number()}),ea=(0,l.createContext)({originalPrompt:null,currentPrompt:null,setOriginalPrompt:()=>{},setCurrentPrompt:()=>{}}),er=()=>(0,l.useContext)(ea);function el(e){var t;let{config:a,onSubmit:n}=e,[s,o]=(0,l.useState)(null),{setOriginalPrompt:d}=er(),[i,c]=(0,l.useState)([]),[u,m]=(0,l.useState)(a.selectedDeviceId),f=(0,U.mN)({resolver:(0,H.u)(et),defaultValues:a}),x=(0,l.useCallback)(async()=>{try{await navigator.mediaDevices.getUserMedia({video:!0});let e=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind).map(e=>({deviceId:e.deviceId,label:e.label||"Camera ".concat(e.deviceId.slice(0,5),"...")}));c(e),e.some(e=>e.deviceId===u)||m(e.length>0?e[0].deviceId:void 0)}catch(e){console.log("Failed to get video devices: ".concat(e))}},[u]);(0,l.useEffect)(()=>(x(),navigator.mediaDevices.addEventListener("devicechange",x),()=>{navigator.mediaDevices.removeEventListener("devicechange",x)}),[x]);let h=async e=>{let t=e.target.files[0];if(t)try{let e=await t.text(),a=JSON.parse(e);o(a),d(a)}catch(e){console.error(e)}};return(0,r.jsx)(D,{...f,children:(0,r.jsxs)("form",{onSubmit:f.handleSubmit(e=>{n({...e,streamUrl:e.streamUrl?e.streamUrl.replace(/\/+$/,""):e.streamUrl,prompt:s,selectedDeviceId:u})}),autoComplete:"off",children:[(0,r.jsx)(A,{control:f.control,name:"streamUrl",render:e=>{let{field:t}=e;return(0,r.jsxs)(z,{className:"mt-4",children:[(0,r.jsx)(J,{children:"Stream URL"}),(0,r.jsx)(q,{children:(0,r.jsx)(V,{placeholder:"Stream URL",...t})}),(0,r.jsx)(M,{})]})}}),(0,r.jsx)(A,{control:f.control,name:"frameRate",render:e=>{let{field:t}=e;return(0,r.jsxs)(z,{className:"mt-4",children:[(0,r.jsx)(J,{children:"Frame Rate"}),(0,r.jsx)(q,{children:(0,r.jsx)(V,{placeholder:"Frame Rate",...t,type:"number"})}),(0,r.jsx)(M,{})]})}}),(0,r.jsxs)("div",{className:"mt-4 mb-4",children:[(0,r.jsx)(P,{children:"Camera"}),(0,r.jsxs)(Y,{required:!0,value:u,onValueChange:e=>{e!==u&&m(e)},children:[(0,r.jsx)(Y.Trigger,{className:"w-full mt-2",children:0===i.length?"No camera devices found":(null===(t=i.find(e=>e.deviceId===u))||void 0===t?void 0:t.label)||"Select camera"}),(0,r.jsx)(Y.Content,{children:0===i.length?(0,r.jsx)(Y.Option,{disabled:!0,value:"no-devices",children:"No camera devices found"}):i.map(e=>(0,r.jsx)(Y.Option,{value:e.deviceId,children:e.label},e.deviceId))})]})]}),(0,r.jsxs)("div",{className:"mt-4 mb-4 grid max-w-sm items-center gap-3",children:[(0,r.jsx)(P,{children:"Comfy Workflow"}),(0,r.jsx)(V,{id:"workflow",type:"file",accept:".json",onChange:h,required:!0})]}),(0,r.jsx)(p,{type:"submit",className:"w-full mt-4 mb-4",children:"Start Stream"})]})})}var en=a(9710);let es=en.Kq,eo=en.bL,ed=en.l9,ei=l.forwardRef((e,t)=>{let{className:a,sideOffset:l=4,...n}=e;return(0,r.jsx)(en.UC,{ref:t,sideOffset:l,className:m("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...n})});function ec(e){let{stream:t,frameRate:a,onStreamReady:n}=e,s=(0,l.useRef)(null),o=(0,l.useRef)(null);return(0,l.useEffect)(()=>{let e=s.current.captureStream(a);return n(e),()=>{e.getTracks().forEach(e=>e.stop())}},[n,a]),(0,l.useEffect)(()=>{let e=s.current.getContext("2d"),t=!0,a=()=>{if(!t)return;let r=o.current;if(!(null==r?void 0:r.videoWidth)){requestAnimationFrame(a);return}let l=Math.max(512/r.videoWidth,512/r.videoHeight),n=r.videoWidth*l,s=r.videoHeight*l;e.fillStyle="black",e.fillRect(0,0,512,512),e.drawImage(r,(512-n)/2,(512-s)/2,n,s),requestAnimationFrame(a)};return a(),()=>{t=!1}},[]),(0,l.useEffect)(()=>{if(!t)return;o.current||(o.current=document.createElement("video"),o.current.muted=!0);let e=o.current;return e.srcObject=t,e.onloadedmetadata=()=>{e.play().catch(e=>{console.log("Video play failed:",e)})},()=>{e.pause(),e.srcObject=null}},[t]),(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("canvas",{ref:s,width:512,height:512,className:"w-full h-full"}),(0,r.jsx)("div",{className:"absolute top-2 right-2 bg-black/50 text-white px-2 py-1 rounded text-sm",children:(0,r.jsx)(es,{children:(0,r.jsxs)(eo,{children:[(0,r.jsxs)(ed,{children:[a," FPS"]}),(0,r.jsx)(ei,{children:(0,r.jsx)("p",{children:"This is the requested FPS of your device."})})]})})})]})})}function eu(e){let{onStreamReady:t,deviceId:a,frameRate:n}=e,[s,o]=(0,l.useState)(null),d=(0,l.useCallback)(e=>{o(t=>(t&&t.getTracks().forEach(e=>e.stop()),e&&e.getVideoTracks()[0].getSettings(),e))},[]),i=(0,l.useCallback)(async()=>{if(!a||0==n)return null;try{return await navigator.mediaDevices.getUserMedia({video:{...a?{deviceId:{exact:a}}:{},width:{ideal:512},height:{ideal:512},aspectRatio:{ideal:1},frameRate:{ideal:n,max:n}}})}catch(e){return null}},[a,n]);return(0,l.useEffect)(()=>{if(a&&0!=n)return i().then(e=>{d(e)}),()=>{d(null)}},[a,n,i,d]),(0,r.jsx)("div",{children:(0,r.jsx)(ec,{stream:s,frameRate:n,onStreamReady:t})})}ei.displayName=en.UC.displayName;var em=a(814);let ef=e=>{let{input:t,value:a,onChange:l}=e;if("combo"===t.widget)return(0,r.jsx)("select",{value:a,onChange:e=>l(e.target.value),className:"p-2 border rounded w-full",children:Array.isArray(t.value)&&t.value.map(e=>(0,r.jsx)("option",{value:e,children:e},e))});let n=t.type.toLowerCase();switch(n){case"boolean":return(0,r.jsx)("input",{type:"checkbox",checked:"true"===a,onChange:e=>l(e.target.checked.toString()),className:"w-5 h-5"});case"number":case"float":case"int":return(0,r.jsx)("input",{type:"number",value:a,onChange:e=>l(e.target.value),min:t.min,max:t.max,step:"float"===n?"0.01":"int"===n?"1":"any",className:"p-2 border rounded w-32"});case"string":return(0,r.jsx)("input",{type:"text",value:a,onChange:e=>l(e.target.value),className:"p-2 border rounded w-full"});default:return console.warn("Unhandled input type: ".concat(t.type)),(0,r.jsx)("input",{type:"text",value:a,onChange:e=>l(e.target.value),className:"p-2 border rounded w-full"})}},ep=e=>{var t,a,n,o,d,i,c,u,m,f,p,x;let{panelState:h,onStateChange:v}=e,{controlChannel:g}=s(),{currentPrompt:b,setCurrentPrompt:j}=er(),[N,w]=(0,l.useState)({}),y=l.useRef(null),C=l.useRef(null);(0,l.useEffect)(()=>()=>{C.current&&clearTimeout(C.current)},[]),(0,l.useEffect)(()=>{g&&(g.send(JSON.stringify({type:"get_nodes"})),g.addEventListener("message",e=>{try{let t=JSON.parse(e.data);"nodes_info"===t.type?w(t.nodes):"prompt_updated"!==t.type||t.success||console.error("[ControlPanel] Failed to update prompt")}catch(e){console.error("[ControlPanel] Error parsing node info:",e)}}))},[g]),(0,l.useEffect)(()=>{var e;let t=h.nodeId&&h.fieldName?null===(e=N[h.nodeId])||void 0===e?void 0:e.inputs[h.fieldName]:null;if(!t||!b)return;let a=!0,r=h.value;switch(t.type.toLowerCase()){case"number":a=/^-?\d*\.?\d*$/.test(h.value)&&""!==h.value,r=parseFloat(h.value);break;case"boolean":a="true"===h.value||"false"===h.value,r="true"===h.value;break;case"string":r=h.value;break;default:t.widget,a=""!==h.value,r=h.value}let l=""!==h.nodeId.trim()&&""!==h.fieldName.trim(),n=y.current,s=!n||n.nodeId!==h.nodeId||n.fieldName!==h.fieldName||n.value!==r;g&&h.isAutoUpdateEnabled&&a&&l&&s&&(C.current&&clearTimeout(C.current),C.current=setTimeout(()=>{let e=JSON.parse(JSON.stringify(b));if(e[h.nodeId]&&e[h.nodeId].inputs){e[h.nodeId].inputs[h.fieldName]=r,y.current={nodeId:h.nodeId,fieldName:h.fieldName,value:r};let t=JSON.stringify({type:"update_prompt",prompt:e});g.send(t),j(e)}},"number"===t.type.toLowerCase()?100:300))},[h.value,h.nodeId,h.fieldName,h.isAutoUpdateEnabled,g,N,b,j]);let S=e=>{var t,a;return"boolean"===e.type.toLowerCase()?(!!e.value).toString():"combo"===e.widget&&Array.isArray(e.value)?(null===(a=e.value[0])||void 0===a?void 0:a.toString())||"":(null===(t=e.value)||void 0===t?void 0:t.toString())||"0"};return(0,r.jsxs)("div",{className:"flex flex-col gap-3 p-3",children:[(0,r.jsxs)("select",{value:h.nodeId,onChange:e=>{v({nodeId:e.target.value,fieldName:"",value:"0"})},className:"p-2 border rounded",children:[(0,r.jsx)("option",{value:"",children:"Select Node"}),Object.entries(N).map(e=>{let[t,a]=e;return(0,r.jsxs)("option",{value:t,children:[t," (",a.class_type,")"]},t)})]}),(0,r.jsxs)("select",{value:h.fieldName,onChange:e=>{var t;let a=e.target.value,r=null===(t=N[h.nodeId])||void 0===t?void 0:t.inputs[a];r?v({fieldName:a,value:S(r)}):v({fieldName:a})},disabled:!h.nodeId,className:"p-2 border rounded",children:[(0,r.jsx)("option",{value:"",children:"Select Field"}),h.nodeId&&(null===(t=N[h.nodeId])||void 0===t?void 0:t.inputs)&&Object.entries(N[h.nodeId].inputs).filter(e=>{let[t,a]=e;return["boolean","number","float","int","string"].includes("string"==typeof a.type?a.type.toLowerCase():String(a.type).toLowerCase())||"combo"===a.widget}).map(e=>{let[t,a]=e;return(0,r.jsxs)("option",{value:t,children:[t," (",a.type,a.widget?" - ".concat(a.widget):"",")"]},t)})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[h.nodeId&&h.fieldName&&(null===(a=N[h.nodeId])||void 0===a?void 0:a.inputs[h.fieldName])&&(0,r.jsx)(ef,{input:N[h.nodeId].inputs[h.fieldName],value:h.value,onChange:e=>{var t;let a=h.nodeId&&h.fieldName?null===(t=N[h.nodeId])||void 0===t?void 0:t.inputs[h.fieldName]:null;if(a&&"number"===a.type){let t=parseFloat(e);if(!isNaN(t)&&(void 0!==a.min&&t<a.min||void 0!==a.max&&t>a.max))return}v({value:e})}}),h.nodeId&&h.fieldName&&(null===(o=N[h.nodeId])||void 0===o?void 0:null===(n=o.inputs[h.fieldName])||void 0===n?void 0:n.type)==="number"&&(0,r.jsx)("span",{className:"text-sm text-gray-600",children:(null===(i=N[h.nodeId])||void 0===i?void 0:null===(d=i.inputs[h.fieldName])||void 0===d?void 0:d.min)!==void 0&&(null===(u=N[h.nodeId])||void 0===u?void 0:null===(c=u.inputs[h.fieldName])||void 0===c?void 0:c.max)!==void 0&&"(".concat(null===(f=N[h.nodeId])||void 0===f?void 0:null===(m=f.inputs[h.fieldName])||void 0===m?void 0:m.min," - ").concat(null===(x=N[h.nodeId])||void 0===x?void 0:null===(p=x.inputs[h.fieldName])||void 0===p?void 0:p.max,")")})]}),(0,r.jsxs)("button",{onClick:()=>{v({isAutoUpdateEnabled:!h.isAutoUpdateEnabled})},disabled:!g,className:"p-2 rounded ".concat(g?h.isAutoUpdateEnabled?"bg-green-500 text-white":"bg-red-500 text-white":"bg-gray-300 text-gray-600 cursor-not-allowed"),children:["Auto-Update ",g?h.isAutoUpdateEnabled?"(ON)":"(OFF)":"(Not Connected)"]})]})};var ex=a(8236),eh=a(3473);let ev=()=>{let[e,t]=(0,l.useState)([0]),[a,n]=(0,l.useState)(1),[s,o]=(0,l.useState)(!1),[d,i]=(0,l.useState)({0:{nodeId:"",fieldName:"",value:"0",isAutoUpdateEnabled:!1}}),c=a=>{t(e.filter(e=>e!==a)),i(e=>{let t={...e};return delete t[a],t})},u=(e,t)=>{i(a=>({...a,[e]:{...a[e],...t}}))};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(p,{onClick:()=>o(!0),className:"fixed bottom-4 right-4 h-12 w-12 rounded-full p-0 shadow-lg hover:shadow-xl transition-shadow",variant:"default",children:(0,r.jsx)(ex.A,{className:"h-6 w-6"})}),(0,r.jsxs)(C,{open:s,onOpenChange:o,direction:"bottom",shouldScaleBackground:!1,children:[(0,r.jsx)("style",{children:"\n            [data-vaul-overlay] {\n              background-color: transparent !important;\n              background: transparent !important;\n            }\n            \n            /* Custom scrollbar styling */\n            #control-panel-drawer ::-webkit-scrollbar {\n              width: 8px;\n              height: 8px;\n            }\n            \n            #control-panel-drawer ::-webkit-scrollbar-track {\n              background: transparent;\n            }\n            \n            #control-panel-drawer ::-webkit-scrollbar-thumb {\n              background: #cbd5e1;\n              border-radius: 4px;\n            }\n            \n            #control-panel-drawer ::-webkit-scrollbar-thumb:hover {\n              background: #94a3b8;\n            }\n          "}),(0,r.jsxs)(I,{id:"control-panel-drawer",className:"max-h-[50vh] min-h-[200px] bg-background/90 backdrop-blur-md border-t shadow-lg overflow-hidden",children:[(0,r.jsx)(E,{className:"sr-only",children:"Control Panels"}),(0,r.jsxs)("div",{className:"flex h-full",children:[(0,r.jsx)("div",{className:"w-12 border-r flex items-start pt-4 justify-center bg-background/50",children:(0,r.jsx)(p,{onClick:()=>{t([...e,a]),i(e=>({...e,[a]:{nodeId:"",fieldName:"",value:"0",isAutoUpdateEnabled:!1}})),n(a+1)},variant:"ghost",size:"icon",className:"h-8 w-8 rounded-md bg-blue-500 hover:bg-blue-600 active:bg-blue-700 transition-colors shadow-sm hover:shadow text-white",title:"Add control panel","aria-label":"Add control panel","data-tooltip":"Add control panel",children:(0,r.jsx)(eh.A,{className:"h-4 w-4"})})}),(0,r.jsx)("div",{className:"flex-1 overflow-x-auto",children:(0,r.jsx)("div",{className:"flex gap-4 p-4 min-h-0",children:e.map(e=>(0,r.jsxs)("div",{className:"flex-none w-80 border rounded-lg bg-white/95 shadow-sm hover:shadow-md transition-shadow overflow-hidden flex flex-col max-h-[calc(50vh-3rem)]",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center p-2 border-b bg-gray-50/80",children:[(0,r.jsxs)("span",{className:"font-medium",children:["Control Panel ",e+1]}),(0,r.jsx)(p,{onClick:()=>c(e),variant:"ghost",size:"sm",className:"h-6 w-6 rounded-full p-0 hover:bg-gray-200/80 transition-colors",children:(0,r.jsx)("span",{className:"text-sm",children:"\xd7"})})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,r.jsx)(ep,{panelState:d[e],onStateChange:t=>u(e,t)})})]},e))})})]})]})]})]})};function eg(e){let{stream:t}=e,a=(0,l.useRef)(null);return(0,l.useEffect)(()=>{a.current&&t&&(a.current.srcObject=t)},[t]),(0,r.jsx)("video",{ref:a,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full"})}function eb(e){let{connected:t,onStreamReady:a}=e,{remoteStream:n,peerConnection:o}=s(),[d,i]=(0,l.useState)(0);return((0,l.useEffect)(()=>{if(!t||!n)return;a();let e=setInterval(()=>{o&&o.getStats().then(e=>{e.forEach(e=>{if("inbound-rtp"===e.type&&"video"===e.kind){let t=e.framesPerSecond;t&&i(Math.round(t))}})})},1e3);return()=>clearInterval(e)},[t,n,o,a]),t&&n)?(0,r.jsxs)("div",{className:"relative w-full h-full",children:[(0,r.jsx)(eg,{stream:n}),(0,r.jsx)("div",{className:"absolute top-2 right-2 bg-black/50 text-white px-2 py-1 rounded text-sm",children:(0,r.jsx)(es,{children:(0,r.jsxs)(eo,{children:[(0,r.jsxs)(ed,{children:[d," FPS"]}),(0,r.jsx)(ei,{children:(0,r.jsx)("p",{children:"This is the FPS of the output stream."})})]})})})]}):(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("video",{className:"w-full h-full object-cover",autoPlay:!0,loop:!0,muted:!0,playsInline:!0,children:(0,r.jsx)("source",{src:"/loading.mp4",type:"video/mp4"})})})}let ej=()=>{let[e,t]=(0,l.useState)(!1),[a,n]=(0,l.useState)(!1),[s,d]=(0,l.useState)(!0),[i,c]=(0,l.useState)(null),[u,m]=(0,l.useState)(void 0),[f,p]=(0,l.useState)({streamUrl:"",frameRate:0,selectedDeviceId:"",prompt:null}),x=(0,l.useRef)(!1),h=(0,l.useCallback)(e=>{c(e)},[]),v=(0,l.useCallback)(()=>{em.oR.success("Started stream!",{id:u}),m(void 0)},[u]),g=(0,l.useCallback)(e=>{p(e)},[]);(0,l.useEffect)(()=>{x.current||(f.streamUrl?(t(!0),m(em.oR.loading("Starting stream...")),x.current=!0):t(!1))},[f.streamUrl]);let b=(0,l.useCallback)(()=>{n(!0),console.debug("Connected!"),x.current=!1},[]),j=(0,l.useCallback)(()=>{n(!1),console.debug("Disconnected!")},[]);return(0,r.jsxs)("main",{className:"fixed inset-0 overflow-hidden overscroll-none",children:[(0,r.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"}),(0,r.jsx)("div",{className:"fixed inset-0 z-[-1] bg-cover bg-[black]",children:(0,r.jsx)(o,{url:f.streamUrl,prompt:f.prompt,connect:e,onConnected:b,onDisconnected:j,localStream:i,children:(0,r.jsxs)("div",{className:"min-h-[100dvh] flex flex-col items-center justify-center md:justify-start",children:[(0,r.jsxs)("div",{className:"w-full max-h-[100dvh] flex flex-col md:flex-row landscape:flex-row justify-center items-center lg:space-x-4 md:pt-[10vh]",children:[(0,r.jsxs)("div",{className:"relative w-full max-w-[100vw] h-auto aspect-square sm:max-w-[640px] sm:max-h-[640px] md:max-w-[512px] md:max-h-[512px] flex justify-center items-center bg-slate-900 sm:border-[2px] md:border-0 lg:border-2 rounded-md",children:[(0,r.jsx)(eb,{connected:a,onStreamReady:v}),(0,r.jsx)("div",{className:"absolute bottom-[8px] right-[8px] w-[70px] h-[70px] sm:w-[90px] sm:h-[90px] bg-slate-800 block md:hidden",children:(0,r.jsx)(eu,{onStreamReady:h,deviceId:f.selectedDeviceId||"",frameRate:f.frameRate})})]}),(0,r.jsx)("div",{className:"hidden md:flex w-full sm:w-full md:w-full h-[50dvh] sm:h-auto md:h-auto max-w-[512px] max-h-[512px] aspect-square justify-center items-center lg:border-2 lg:rounded-md bg-slate-800",children:(0,r.jsx)(eu,{onStreamReady:h,deviceId:f.selectedDeviceId||"",frameRate:f.frameRate})})]}),a&&(0,r.jsx)(ev,{}),(0,r.jsx)(ee,{open:s,onOpenChange:d,onSave:g})]})})})]})};function eN(){let[e,t]=(0,l.useState)(null),[a,n]=(0,l.useState)(null);return(0,l.useEffect)(()=>{e&&n(JSON.parse(JSON.stringify(e)))},[e]),(0,r.jsx)(ea.Provider,{value:{originalPrompt:e,currentPrompt:a,setOriginalPrompt:t,setCurrentPrompt:n},children:(0,r.jsx)("div",{className:"flex flex-col",children:(0,r.jsx)("div",{className:"w-full",children:(0,r.jsx)(ej,{})})})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[814,750,441,517,358],()=>t(6182)),_N_E=e.O()}]);